---
title: "Analysis of longitudinal data"
---

# Analysis of longitudinal data

*Tuomas Keski-Kuha 5.12.2021*

```{r}
# access libraries: 
library(dplyr)
library(tidyr)
library(ggplot2)
library(corrplot)
library(GGally)
library(reshape2)
library(plotly)
library(tidyverse)
library(rstatix)
library(ggpubr)
library(lme4)

install.packages("lme4")

```

----------------------------------------------------

## Graphical Displays and Summary Measure Approach for RATS data

----------------------------------------------------

*Exercise 1: Implement the analyses of Chapter 8 of MABS using the RATS data. (0-7 points: 0-4 points for graphs or analysis results + 0-3 points for their interpretations)*

----------------------------------------------------

### Rats, it's RATS - Graphical Displays of RATS

----------------------------------------------------


Graphical displays of data are almost always useful for exposing patterns in the data, particularly when these are unexpected; this might be of great help in suggesting which class of models might be most sensibly applied in the later more formal analysis.

```{r}

# load the data

# set the working directory to iods project folder
setwd("c:/Tuomas/Opiskelu/Open Data Science/IODS-project")
RATSL <- read.csv(file = "data/RATSL.csv")

RATSL <- within(RATSL, {
  ID <- factor(ID)
  Group <- factor(Group)
})

#  read original RATS data
RATS <- read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/rats.txt", sep  ="\t", header = T)

RATS <- within(RATS, {
  ID <- factor(ID)
  Group <- factor(Group)
})


# Plotting the RATSL data
p1 <- ggplot(RATSL, aes(x = Time, y = Weight, linetype = ID))
p2 <- p1 + geom_line() + scale_linetype_manual(values = rep(1:10, times=4))
p3 <- p2 + facet_grid(. ~ Group, labeller = label_both)
p4 <- p3 + theme_bw() + theme(legend.position = "none")
p5 <- p4 + theme(panel.grid.minor.y = element_blank())
p6 <- p5 + scale_y_continuous(limits = c(min(RATSL$Weight), max(RATSL$Weight)))
p6

```


```{r}
# Standardise the scores for RATS
RATSL_std <- RATSL %>%
  group_by(Time) %>%
  mutate( stdrats = (Weight - mean(Weight))/sd(Weight) ) %>%   ungroup()

glimpse(RATSL_std)


p1 <- ggplot(RATSL_std, aes(x = Time, y = stdrats, linetype = ID))
p2 <- p1 + geom_line() + scale_linetype_manual(values = rep(1:10, times=4))
p3 <- p2 + facet_grid(. ~ Group, labeller = label_both)
p4 <- p3 + theme_bw() + theme(legend.position = "none")
p5 <- p4 + theme(panel.grid.minor.y = element_blank())
p6 <- p5 + scale_y_continuous(name = "standardized rats")
p6

ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "Weight (grams)") +
  theme(legend.position = "top")
```

----------------------------------------------------

### Summary Measure Approach of RATS

----------------------------------------------------


```{r}

# Number of weeks, baseline (week 0) included
n <- RATSL$Time %>% unique() %>% length()


# Make a summary data:
RATSS <- RATSL %>%
  group_by(Group, Time) %>%
  summarise( mean=mean(Weight), se=sd(Weight)/sqrt(n)) %>%
  ungroup()


p1 <- ggplot(RATSS, aes(x = Time, y = mean, linetype = Group, shape = Group))
p2 <- p1 + geom_line() + scale_linetype_manual(values = c(1,2,3))
p3 <- p2 + geom_point(size=2) + scale_shape_manual(values = c(1,2,3))
p4 <- p3 + geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=1)
p5 <- p4 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p6 <- p5 + theme(legend.position = c(0.9,0.45))
p7 <- p6 + scale_y_continuous(name = "mean(Weight) +/- se(Weight)")
p7


```

```{r}
# Create a summary data by group and subject with mean as the summary variable 

RATSL8S <- RATSL %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()

# Draw a boxplot of the mean versus treatment
ggplot(RATSL8S, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(bprs), Times 1-11")

# Create a new data by filtering the outlier and adjust the ggplot code the draw the plot again with the new data
RATSL8S1 <- RATSL8S %>%
  filter(mean < 590)

ggplot(RATSL8S1, aes(x = Group, y = mean)) +
  geom_boxplot() +
  stat_summary(fun = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(bprs), Times 1-11")


```



```{r}

# Perform a three-sample t-test
pwc <- RATSL8S1 %>%
  pairwise_t_test(mean ~ Group, p.adjust.method = "bonferroni")
pwc

# Add the baseline from the original data as a new variable to the summary data
RATSL8S2 <- RATSL8S %>%
  mutate(baseline = RATS$WD1)

# Fit the linear model with the mean as the response 
fit <- lm(mean ~ baseline + Group, data = RATSL8S2)

summary(fit)

# Compute the analysis of variance table for the fitted model with anova()
anova(fit)


```


----------------------------------------------------

##  Linear Mixed Effects Models for Normal Response Variables for BPRS data

----------------------------------------------------

*Exercise 2: Implement the analyses of Chapter 9 of MABS using the BPRS data. (0-8 points: 0-4 points for graphs or analysis results + 0-4 points for their interpretations)*

----------------------------------------------------

In the BPRS data 40 male subjects were randomly assigned to one of two treatment groups and each subject was rated on the brief psychiatric rating scale (BPRS) measured before treatment began (week 0) and then at weekly intervals for eight weeks. The BPRS assesses the level of 18 symptom constructs such as hostility, suspiciousness, hallucinations and grandiosity; each of these is rated from one (not present) to seven (extremely severe). The scale is used to evaluate patients suspected of having schizophrenia.

Let's load the data, take a glimpse, and draw a plot: 
```{r}

# load the data

# set the working directory to iods project folder
setwd("c:/Tuomas/Opiskelu/Open Data Science/IODS-project")
BPRSL <- read.csv(file = "data/BPRSL.csv")

BPRSL <- within(BPRSL, {
  treatment <- factor(treatment)
  subject <- factor(subject)
})

# Glimpse the data

glimpse(BPRSL)

# Draw the plot
ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))
```


### Linear regression model

First, we try just a simple linear regression model on the BPRS-data with *bprs* as response and *week* and *treatment* as explanatory variables. Here we ignore the repeated-measures structure of the data, and assume that observations are all independent knowing that there is same subjects measured multiple times and these observations tend to correlate with each other as we measure same subject. 

```{r}

# create a regression model BPRS_reg
BPRS_reg <- lm(bprs ~ week + treatment, data = BPRSL)

# print out a summary of the model
summary(BPRS_reg)

```


----------------------------------------------------

## Random intercept model

----------------------------------------------------

The previous model assumes independence of the repeated measures of bprs, and this assumption is highly unlikely. So, now we will move on to consider both some more appropriate graphics and appropriate models.

To begin the more formal analysis of the *BPRS* data, we will first fit the random intercept model for the same two explanatory variables: *week* and *treatment* Fitting a random intercept model allows the linear regression fit for each subject to differ in intercept from other subjects. So in this model it's possible to have different profiles wiht symptom development. 


```{r}

# Create a random intercept model
BPRS_rim <- lmer(bprs ~ week + treatment + (1 | subject), data = BPRSL, REML = FALSE)

# Print the summary of the model
summary(BPRS_rim)

```

----------------------------------------------------

### Random intercept and random slope model

----------------------------------------------------

Now we can move on to fit the random intercept and random slope model to the data. Fitting a random intercept and random slope model allows the linear regression fits for each individual to differ in intercept but also in slope. This way it is possible to account for the individual differences in the *bprs* development profiles, but also the effect of time.

```{r}

# create a random intercept and random slope model
BPRS_rims <- lmer(bprs ~ week + treatment + (week | subject), data = BPRSL, REML = FALSE)

# print a summary of the model
summary(BPRS_rims)

```


```{r}
# perform an ANOVA test on the random intercept model and the random intercept and random slope model
anova(BPRS_rims, BPRS_rim)

```

----------------------------------------------------

### Random intercept and random slope model with interaction

----------------------------------------------------

Finally, we can fit a random intercept and slope model that allows for a group Ã— time interaction.

```{r}
# create a random intercept and random slope model
BPRS_rimsi <- lmer(bprs ~ week * treatment + (week | subject), data = BPRSL, REML = FALSE)

# print a summary of the model
summary(BPRS_rimsi)

```

Then let's look at the analysis of variance between two latest models: random intercept with random slope with and without group and time interaction.  

```{r}
# perform an ANOVA test on the two models
anova(BPRS_rimsi, BPRS_rims)

```

We will draw also the individual models of the latest model with interaction. So well get a fitted line for each of the subjects. 

```{r}
# Create a vector of the fitted values
fitted <- fitted(BPRS_rimsi)

# Create a new column fitted to BPRSL
BPRSL_rimsifit <- BPRSL %>%
  mutate(fitted)

# draw the plot of BPRSL
ggplot(BPRSL_rimsifit, aes(x = week, y = fitted, linetype = subject)) +
  geom_line()


```

-----------------------------------------------------

### Comments on the exercises and learning

-----------------------------------------------------
