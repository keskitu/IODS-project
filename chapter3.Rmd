# Logistic regression

*Tuomas Keski-Kuha 15.11.2021*

## Data exploration and finding relevant variables

```{r}
# access a few libraries: 
library(dplyr)
library(tidyr)
library(ggplot2)

# first let's read the data: 
alc<- read.csv(file = "https://github.com/rsund/IODS-project/raw/master/data/alc.csv", 
                      stringsAsFactors = FALSE, sep = ",")

# let's study the data structure etc. 
glimpse(alc)
colnames(alc)

```

**Data set information** *(straight from the web page)*: 

This data approach student achievement in secondary education of two Portuguese schools. The data attributes include student grades, demographic, social and school related features) and it was collected by using school reports and questionnaires. Important note: the target attribute G3 has a strong correlation with attributes G2 and G1. This occurs because G3 is the final year grade (issued at the 3rd period), while G1 and G2 correspond to the 1st and 2nd period grades. It is more difficult to predict G3 without G2 and G1, but such prediction is much more useful (see paper source for more details).

Still we are going to use the data to predict binary variable for alcohol consuption (high_use).

Expected 4 variables to effect alcohol consumption are as follows (the variable picking was biased as I did see the results in the datacamp exercise :D ). Anyway let's pick 

- **sex:** it is quite typical that males drink more 
- **absences:** one could think that absences would go up for high alcohol users due to hangovers and other side effects
- **failures:** same reasoning as for absences
- **goout:** thinking here is quite obvious, someone goes out more is perhaps drinkin more

Let's draw some plots and tables if we could see whether there might be any relationship between target variable (high_use) and predictors. 


```{r}
# produce summary statistics by group for studying relationship between high_use and sex
alc %>% group_by(sex, high_use) %>% summarise(count = n())

# let's draw a plot to study how absences might relate to the target variable
g1 <- ggplot(alc, aes(x = high_use, y = absences, col = sex))

g1 + geom_boxplot() + ggtitle("Student absences by alcohol consumption and sex")

```

- **sex:** It looks lie there is big difference in high alcogol users between sexes. Males tend to use much more, as expected before. 
- **absences:** In the plot we draw absences with sex, and there we could also see that in high users there is more tendency to be absent from the classes. It is interesting that for females the difference is not that significant as it is for males. 

```{r}
# initialize a plot of high_use related to gout
g2 <- ggplot(data = alc, aes(x = goout, fill = high_use))

# define the plot as a bar plot and draw it
g2 + geom_bar() + ggtitle("Student go-out-tendency by high alcohol consumption")


#  let's count few crosstables for examining high_use relatedness to failures
table(high_use = alc$high_use, failures = alc$failures)

```

- **goout:** It can be seen from the bar chart that students who go out more will use alcohol more. The effect is quite clear, and this was quite expected. 
- **failures:** There can be seen a tendency to fail classes in the past if one is high user as expected, but this variable is tricky because 1-3 failure classes has so few instances. It could disturb modeling with this feature. 

## Logistic regression model

In this chapter, let's apply a logistic regression model to predict high alcohol use. For the model we use those variables which seemed have an effect to high alcohol use *(sex, absences, go_out, failures)*. 

```{r}
# find the model with glm() (target high_use)
m <- glm(high_use ~ sex + goout + absences + failures, data = alc, family = "binomial")

summary(m)
```

Model summary seems to tell that all of the predictive variables have good fit overall and are statistically significant (all others have p-value < 0.001, but for failures the p-value is 0,03 which is not that significant, and it is reasonable to assume that it won't be significant for prediction power). Also here we cannot be sure that there might be strong correlations between predictors, so perhaps it could be wise to study those also. 

Let's also present the coefficients and also oddsrations, and confidence intervals: 

```{r}
# compute odds ratios (OR) round the results
OR <- coef(m) %>% exp %>% round(2)

# compute confidence intervals (CI), round the results
CI <- confint(m) %>% exp %>% round(2)

# print out the odds ratios with their confidence intervals
cbind(OR, CI)

```
Interpret: 

## Predictions

Let's use the logistic regression model for predicting high alcohol use from the selected data. Well calculate probability for high alcohol use and then form a new variable which 

```{r}
# predict() the probability of high_use
probabilities <- predict(m, type = "response")

# add the predicted probabilities to 'alc'
alc <- mutate(alc, probability = probabilities)

# use the probabilities to make a prediction of high_use
alc <- mutate(alc, prediction = probability > 0.5)

# tabulate the target variable versus the predictions
table(high_use = alc$high_use, prediction = alc$prediction)

```